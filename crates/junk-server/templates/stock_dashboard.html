<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/stylesheet.css">
    <title>Stock Dashboard</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'JetBrains Mono', monospace;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-height: 100vh;
            overflow: hidden;
        }
        .search-bar {
            background: var(--background);
            padding: 10px;
            border-bottom: 1px solid var(--text-muted);
            display: flex;
            justify-content: center;
        }

        #searchInput {
            width: 50%; /* Adjust width as needed */
            padding: 8px 12px;
            background: var(--graph-bg);
            color: var(--foreground);
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #searchInput::placeholder {
            color: var(--text-muted);
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 5px var(--accent-blue);
        }
        .tab-bar {
            display: flex;
            justify-content: center;
            background: var(--background);
            padding: 10px 0;
            border-bottom: 1px solid var(--text-muted);
        }
        .tab {
            padding: 8px 20px;
            margin: 0 5px;
            background: var(--background);
            color: var(--foreground);
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
        }
        .tab.active {
            background: var(--foreground);
            color: var(--background);
        }
        .tab:hover {
            background: var(--highlight-bg);
        }
        .tab:focus {
            outline: none;
            box-shadow: 0 0 5px var(--accent-blue);
        }
        .tab:active {
            background: var(--accent-magenta);
            color: var(--background);
        }
        .chart-container {
            width: 100%;
            height: calc(100vh - 70px); /* Adjusted from 50px to 70px for search bar (~20px) + tab bar (~50px) */
            padding: 0 20px;
            box-sizing: border-box;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
            position: absolute;
            top: 0;
            left: 0;
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        .active {
            opacity: 1;
            z-index: 1;
        }
        .log-button-container {
            position: absolute;
            bottom: 20px;
            right: 40px; /* Adjusted to not overlap with arrow button */
            z-index: 2; /* Above chart */
            visibility: hidden; /* Reserve space, just hide visually */
        }
        .log-button-container.active {
            visibility: visible; /* Show when active */
        }
        button {
            font-family: 'JetBrains Mono', monospace;
            padding: 8px 16px;
            background: var(--foreground);
            border: none;
            color: var(--background);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--highlight-bg);
        }

        button:focus {
            outline: none;
            box-shadow: 0 0 5px var(--accent-blue);
        }

        button:active {
            background-color: var(--accent-magenta);
        }

        /* Specific styles for the log button to invert it */
        #toggleLogScale {
            background: transparent; /* Remove the cream background */
            color: var(--foreground); /* Text in cream */
            border: 1px solid var(--foreground); /* Outline in cream */
        }

        #toggleLogScale:hover {
            background: var(--highlight-bg); /* Keep hover effect */
            color: var(--foreground); /* Ensure text stays cream */
            border-color: var(--foreground); /* Keep outline cream */
        }

        #toggleLogScale:focus {
            outline: none;
            box-shadow: 0 0 5px var(--accent-blue); /* Retain focus effect */
            color: var(--foreground); /* Ensure text stays cream */
            border-color: var(--foreground); /* Keep outline cream */
        }

        #toggleLogScale:active {
            background: var(--accent-magenta); /* Active state background */
            color: var(--background); /* Text switches to dark for contrast */
            border-color: var(--accent-magenta); /* Outline matches active background */
        }
        .arrow-button {
            position: relative;
            font-size: 24px;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            background: var(--background);
            color: var(--foreground);
        }
        .arrow-button:hover {
            background: var(--highlight-bg);
            color: var(--background);
        }
        .arrow-button:focus {
            box-shadow: 0 0 5px var(--accent-blue);
        }
        .arrow-button:active {
            background: var(--accent-magenta);
            color: var(--background);
        }
        .chart-wrapper {
            position: relative;
            flex-grow: 1;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search stocks..." />
    </div>
    <div class="tab-bar">
        <button class="tab active" data-chart-index="0">Price + Volume</button>
        <button class="tab" data-chart-index="1">Volume Only</button>
        <button class="tab" data-chart-index="2">Price Only</button>
    </div>
    <!-- Rest of your HTML remains unchanged -->

    <div class="chart-container" id="chartContainer"> 
        <button class="arrow-button" id="prevChart">←</button>
        <div class="chart-wrapper">
            <canvas id="priceVolumeChart" class="active"></canvas>
            <canvas id="volumeChart" class="hidden"></canvas>
            <canvas id="priceChart" class="hidden"></canvas>
            <div class="log-button-container active">
                <button id="toggleLogScale">Toggle Log Scale</button>
            </div>
        </div>
        <button class="arrow-button" id="nextChart">→</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        console.log('Chart.js loaded:', typeof Chart !== 'undefined');

        let prices;
        try {
            const prices_json = '{{ prices | safe }}';
            prices = JSON.parse(prices_json);
            console.log('Raw prices data:', prices_json);
            console.log('Parsed prices:', prices);
        } catch (e) {
            console.error('Error parsing prices:', e);
            prices = [
                { date: '2020-01-02', adj_close: 140.20, volume: 350000000, volume_7ma: 320000000, volume_90ma: 300000000 },
                { date: '2020-01-03', adj_close: 145.60, volume: 280000000, volume_7ma: 310000000, volume_90ma: 290000000 },
                { date: '2020-01-06', adj_close: 148.20, volume: 300000000, volume_7ma: 300000000, volume_90ma: 280000000 },
                { date: '2020-01-07', adj_close: 147.80, volume: 250000000, volume_7ma: 290000000, volume_90ma: 270000000 },
                { date: '2025-02-01', adj_close: 280.00, volume: 150000000, volume_7ma: 200000000, volume_90ma: 220000000 }
            ];
            console.log('Using fallback data:', prices);
        }

        prices.sort((a, b) => new Date(b.date) - new Date(a.date));
        const labels = prices.map(item => item.date).reverse();
        const priceData = prices.map(item => item.adj_close).reverse();
        const volumeData = prices.map(item => item.volume || 0).reverse();
        const volume7MAData = prices.map(item => item.volume_7ma || 0).reverse();
        const volume90MAData = prices.map(item => item.volume_90ma || 0).reverse();

        const theme = {
            background: getComputedStyle(document.documentElement).getPropertyValue('--background').trim() || '#1f2023',
            foreground: getComputedStyle(document.documentElement).getPropertyValue('--foreground').trim() || '#bcb28d',
            accentBlue: getComputedStyle(document.documentElement).getPropertyValue('--accent-blue').trim() || '#58b2dc',
            accentMagenta: getComputedStyle(document.documentElement).getPropertyValue('--accent-magenta').trim() || '#e03c8a',
            textMuted: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim() || '#707c74',
            graphBg: getComputedStyle(document.documentElement).getPropertyValue('--graph-bg').trim() || '#212121'
        };

        const charts = [];

        const priceVolumeCtx = document.getElementById('priceVolumeChart').getContext('2d');
        let priceVolumeChart;
        if (!priceVolumeCtx) {
            console.error('Price + Volume chart context not found!');
        } else {
            priceVolumeChart = new Chart(priceVolumeCtx, {
                data: {
                    labels: labels,
                    datasets: [
                        { type: 'line', label: 'Adjusted Close Price', data: priceData, borderColor: theme.foreground, borderWidth: 1, fill: false, pointRadius: 0, yAxisID: 'y-price' },
                        { type: 'bar', label: 'Volume', data: volumeData, backgroundColor: theme.accentMagenta + '80', borderColor: theme.accentMagenta, borderWidth: 1, yAxisID: 'y-volume', barPercentage: 0.7, categoryPercentage: 0.8 },
                        { type: 'line', label: 'Volume 7MA', data: volume7MAData, borderColor: theme.textMuted, borderWidth: 1, fill: false, pointRadius: 0, yAxisID: 'y-volume' },
                        { type: 'line', label: 'Volume 90MA', data: volume90MAData, borderColor: theme.foreground, borderWidth: 1, fill: false, pointRadius: 0, yAxisID: 'y-volume' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 20, bottom: 20, left: 20, right: 20 } },
                    scales: {
                        x: { type: 'category', title: { display: true, text: 'Date', color: theme.foreground }, ticks: { color: theme.textMuted, maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 }, grid: { display: true, color: theme.textMuted + '33', drawBorder: true } },
                        'y-price': { position: 'left', title: { display: true, text: 'Price', color: theme.foreground }, ticks: { color: theme.textMuted }, beginAtZero: false, suggestedMin: Math.min(...priceData) * 0.9, suggestedMax: Math.max(...priceData) * 1.1, grid: { display: true, color: theme.textMuted + '33', drawBorder: true }, type: 'linear', stack: 'price', stackWeight: 1 },
                        'y-volume': { position: 'right', title: { display: true, text: 'Volume', color: theme.foreground }, ticks: { color: theme.textMuted }, grid: { display: false }, beginAtZero: true, max: Math.max(...volumeData) * 5, stack: 'volume', stackWeight: 5 }
                    },
                    plugins: {
                        title: { display: true, text: 'Price + Volume Chart', color: theme.foreground },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`; } }, backgroundColor: theme.graphBg, bodyColor: theme.foreground, titleColor: theme.foreground },
                        legend: { labels: { color: theme.foreground } }
                    },
                    elements: { line: { tension: 0.1 } }
                }
            });
            charts.push(priceVolumeChart);
        }

        const volumeCtx = document.getElementById('volumeChart').getContext('2d');
        if (!volumeCtx) {
            console.error('Volume chart context not found!');
        } else {
            const volumeChart = new Chart(volumeCtx, {
                data: {
                    labels: labels,
                    datasets: [
                        { type: 'bar', label: 'Volume', data: volumeData, backgroundColor: theme.accentMagenta + '80', borderColor: theme.accentMagenta, borderWidth: 1, yAxisID: 'y' },
                        { type: 'line', label: 'Volume 7MA', data: volume7MAData, borderColor: theme.textMuted, borderWidth: 2, fill: false, pointRadius: 0, yAxisID: 'y' },
                        { type: 'line', label: 'Volume 90MA', data: volume90MAData, borderColor: theme.accentBlue, borderWidth: 2, fill: false, pointRadius: 0, yAxisID: 'y' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'category', title: { display: true, text: 'Date', color: theme.foreground }, ticks: { color: theme.textMuted, maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 }, grid: { color: theme.graphBg + '33' } },
                        y: { title: { display: true, text: 'Volume', color: theme.foreground }, ticks: { color: theme.textMuted }, beginAtZero: true, max: Math.max(...volumeData) * 5, grid: { color: theme.graphBg + '33' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Volume Chart', color: theme.foreground },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`; } }, backgroundColor: theme.graphBg, bodyColor: theme.foreground, titleColor: theme.foreground },
                        legend: { labels: { color: theme.foreground } }
                    }
                }
            });
            charts.push(volumeChart);
        }

        const priceCtx = document.getElementById('priceChart').getContext('2d');
        if (!priceCtx) {
            console.error('Price chart context not found!');
        } else {
            const priceChart = new Chart(priceCtx, {
                data: {
                    labels: labels,
                    datasets: [{ type: 'line', label: 'Adjusted Close Price', data: priceData, borderColor: theme.accentBlue, borderWidth: 2, fill: false, pointRadius: 0, yAxisID: 'y' }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'category', title: { display: true, text: 'Date', color: theme.foreground }, ticks: { color: theme.textMuted, maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 }, grid: { color: theme.graphBg + '33' } },
                        y: { title: { display: true, text: 'Price', color: theme.foreground }, ticks: { color: theme.textMuted }, beginAtZero: false, suggestedMin: Math.min(...priceData) * 0.9, suggestedMax: Math.max(...priceData) * 1.1, grid: { color: theme.graphBg + '33' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Price Chart', color: theme.foreground },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`; } }, backgroundColor: theme.graphBg, bodyColor: theme.foreground, titleColor: theme.foreground },
                        legend: { labels: { color: theme.foreground } }
                    },
                    elements: { line: { tension: 0.1 } }
                }
            });
            charts.push(priceChart);
        }

        // Chart Navigation
        let activeChartIndex = 0;
        const chartCanvases = document.querySelectorAll('.chart-wrapper > canvas');
        const logButtonContainer = document.querySelector('.log-button-container');
        const prevButton = document.getElementById('prevChart');
        const nextButton = document.getElementById('nextChart');
        const tabs = document.querySelectorAll('.tab');

        function updateChartVisibility() {
            chartCanvases.forEach((canvas, index) => {
                if (index === activeChartIndex) {
                    canvas.classList.add('active');
                    canvas.classList.remove('hidden');
                } else {
                    canvas.classList.add('hidden');
                    canvas.classList.remove('active');
                }
            });

            tabs.forEach((tab, index) => {
                if (index === activeChartIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Show/hide log button container
            if (activeChartIndex === 0) {
                logButtonContainer.classList.add('active');
                if (priceVolumeChart) {
                    priceVolumeChart.resize(); // Force resize when switching to Price + Volume
                }
            } else {
                logButtonContainer.classList.remove('active');
            }
        }

        updateChartVisibility(); // Initialize

        // Tab navigation
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                activeChartIndex = parseInt(this.getAttribute('data-chart-index'));
                updateChartVisibility();
            });
        });

        // Arrow key navigation
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowRight') {
                activeChartIndex = (activeChartIndex + 1) % chartCanvases.length;
                updateChartVisibility();
            } else if (event.key === 'ArrowLeft') {
                activeChartIndex = (activeChartIndex - 1 + chartCanvases.length) % chartCanvases.length;
                updateChartVisibility();
            }
        });

        // Arrow button navigation
        nextButton.addEventListener('click', function() {
            activeChartIndex = (activeChartIndex + 1) % chartCanvases.length;
            updateChartVisibility();
        });

        prevButton.addEventListener('click', function() {
            activeChartIndex = (activeChartIndex - 1 + chartCanvases.length) % chartCanvases.length;
            updateChartVisibility();
        });

        // Toggle Log Scale
        const toggleLogScaleButton = document.getElementById('toggleLogScale');
        if (toggleLogScaleButton) {
            toggleLogScaleButton.addEventListener('click', function() {
                if (priceVolumeChart) {
                    const yAxis = priceVolumeChart.options.scales['y-price'];
                    yAxis.type = yAxis.type === 'logarithmic' ? 'linear' : 'logarithmic';
                    priceVolumeChart.update();
                } else {
                    console.error('priceVolumeChart is not defined.');
                }
            });
        }
    </script>
</body>
</html>