<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/stylesheet.css">
    <title>Stock Dashboard</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'JetBrains Mono', monospace;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-height: 100vh;
            overflow: hidden;
        }
        .search-bar {
            background: var(--background);
            padding: 10px;
            border-bottom: 1px solid var(--text-muted);
            display: flex;
            justify-content: center;
        }
        #searchInput {
            width: 50%;
            padding: 8px 12px;
            background: var(--graph-bg);
            color: var(--foreground);
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #searchInput::placeholder {
            color: var(--text-muted);
        }
        #searchInput:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 5px var(--accent-blue);
        }
        .tab-bar {
            display: flex;
            justify-content: center;
            background: var(--background);
            padding: 10px 0;
            border-bottom: 1px solid var(--text-muted);
        }
        .tab {
            padding: 8px 20px;
            margin: 0 5px;
            background: var(--background);
            color: var(--foreground);
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
        }
        .tab.active {
            background: var(--foreground);
            color: var(--background);
        }
        .tab:hover {
            background: var(--highlight-bg);
        }
        .tab:focus {
            outline: none;
            box-shadow: 0 0 5px var(--accent-blue);
        }
        .tab:active {
            background: var(--accent-magenta);
            color: var(--background);
        }
        .chart-container {
            width: 100%;
            height: calc(100vh - 70px); /* Adjusted for search bar (~20px) + tab bar (~50px) */
            padding: 0 20px;
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: space-between;
        }
        .chart-wrapper {
            position: relative;
            flex-grow: 1;
            height: 100%;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
            position: absolute;
            top: 0;
            left: 0;
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        .active {
            opacity: 1;
            z-index: 1;
        }
        .controls-bar {
            background: var(--background);
            padding: 10px;
            border-top: 1px solid var(--text-muted);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            visibility: hidden; /* Hidden by default, shown only for Price + Volume */
            z-index: 2;
        }
        .controls-bar.active {
            visibility: visible;
        }
        #dateRange {
            padding: 8px 12px;
            background: var(--graph-bg);
            color: var(--foreground);
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #dateRange:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 5px var(--accent-blue);
        }
        button {
            font-family: 'JetBrains Mono', monospace;
            padding: 8px 16px;
            background: var(--foreground);
            border: none;
            color: var(--background);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: var(--highlight-bg);
        }
        button:focus {
            outline: none;
            box-shadow: 0 0 5px var(--accent-blue);
        }
        button:active {
            background-color: var(--accent-magenta);
        }
        #toggleLogScale {
            background: transparent;
            color: var(--foreground);
            border: 1px solid var(--foreground);
        }
        #toggleLogScale:hover {
            background: var(--highlight-bg);
            color: var(--foreground);
            border-color: var(--foreground);
        }
        #toggleLogScale:focus {
            outline: none;
            box-shadow: 0 0 5px var(--accent-blue);
            color: var(--foreground);
            border-color: var(--foreground);
        }
        #toggleLogScale:active {
            background: var(--accent-magenta);
            color: var(--background);
            border-color: var(--accent-magenta);
        }
        .arrow-button {
            position: relative;
            font-size: 24px;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            background: var(--background);
            color: var(--foreground);
        }
        .arrow-button:hover {
            background: var(--highlight-bg);
            color: var(--background);
        }
        .arrow-button:focus {
            box-shadow: 0 0 5px var(--accent-blue);
        }
        .arrow-button:active {
            background: var(--accent-magenta);
            color: var(--background);
        }
    </style>
</head>
<body>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search stocks..." />
    </div>
    <div class="tab-bar">
        <button class="tab active" data-chart-index="0">Price + Volume</button>
        <button class="tab" data-chart-index="1">Volume Only</button>
        <button class="tab" data-chart-index="2">Price Only</button>
    </div>
    <div class="chart-container" id="chartContainer"> 
        <div style="display: flex; align-items: center; justify-content: space-between; flex-grow: 1;">
            <button class="arrow-button" id="prevChart">←</button>
            <div class="chart-wrapper">
                <canvas id="priceVolumeChart" class="active"></canvas>
                <canvas id="volumeChart" class="hidden"></canvas>
                <canvas id="priceChart" class="hidden"></canvas>
            </div>
            <button class="arrow-button" id="nextChart">→</button>
        </div>
        <div class="controls-bar active">
            <select id="dateRange">
                <option value="1M">1 Month</option>
                <option value="3M">3 Months</option>
                <option value="6M">6 Months</option>
                <option value="1Y">1 Year</option>
                <option value="5Y">5 Years</option>
                <option value="ALL" selected>All</option>
            </select>
            <button id="toggleLogScale">Toggle Log Scale</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        console.log('Chart.js loaded:', typeof Chart !== 'undefined');

        let prices;
        try {
            const prices_json = '{{ prices | safe }}';
            prices = JSON.parse(prices_json);
            console.log('Raw prices data:', prices_json);
            console.log('Parsed prices:', prices);
        } catch (e) {
            console.error('Error parsing prices:', e);
            prices = [
                { date: '2020-01-02', adj_close: 140.20, volume: 350000000, volume_7ma: 320000000, volume_90ma: 300000000 },
                { date: '2020-01-03', adj_close: 145.60, volume: 280000000, volume_7ma: 310000000, volume_90ma: 290000000 },
                { date: '2020-01-06', adj_close: 148.20, volume: 300000000, volume_7ma: 300000000, volume_90ma: 280000000 },
                { date: '2020-01-07', adj_close: 147.80, volume: 250000000, volume_7ma: 290000000, volume_90ma: 270000000 },
                { date: '2025-02-01', adj_close: 280.00, volume: 150000000, volume_7ma: 200000000, volume_90ma: 220000000 }
            ];
            console.log('Using fallback data:', prices);
        }

        prices.sort((a, b) => new Date(b.date) - new Date(a.date));
        const fullLabels = prices.map(item => item.date).reverse();
        const fullPriceData = prices.map(item => item.adj_close).reverse();
        const fullPrice20MAData = prices.map(item => item.adj_close_20ma).reverse();
        const fullPrice50MAData = prices.map(item => item.adj_close_50ma).reverse();
        const fullPrice200MAData = prices.map(item => item.adj_close_200ma).reverse();
        const fullPercPriceData = prices.map(item => item.perc).reverse();
        const fullVolumeData = prices.map(item => item.volume || 0).reverse();
        const fullVolume7MAData = prices.map(item => item.volume_7ma || 0).reverse();
        const fullVolume90MAData = prices.map(item => item.volume_90ma || 0).reverse();

        function filterDataByRange(range) {
            const now = new Date('2025-02-20');
            let cutoffDate;

            switch (range) {
                case '1M':
                    cutoffDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                case '3M':
                    cutoffDate = new Date(now.setMonth(now.getMonth() - 3));
                    break;
                case '6M':
                    cutoffDate = new Date(now.setMonth(now.getMonth() - 6));
                    break;
                case '1Y':
                    cutoffDate = new Date(now.setFullYear(now.getFullYear() - 1));
                    break;
                case '5Y':
                    cutoffDate = new Date(now.setFullYear(now.getFullYear() - 5));
                    break;
                case 'ALL':
                default:
                    cutoffDate = null;
            }

            if (!cutoffDate) {
                return {
                    labels: fullLabels,
                    priceData: fullPriceData,
                    price20MAData: fullPrice20MAData,
                    price50MAData: fullPrice50MAData,
                    price200MAData: fullPrice200MAData,
                    volumeData: fullVolumeData,
                    volume7MAData: fullVolume7MAData,
                    volume90MAData: fullVolume90MAData
                };
            }

            const filteredPrices = prices.filter(item => new Date(item.date) >= cutoffDate).reverse();
            return {
                labels: filteredPrices.map(item => item.date),
                priceData: filteredPrices.map(item => item.adj_close),
                price20MAData: filteredPrices.map(item => item.adj_close_20ma),
                price50MAData: filteredPrices.map(item => item.adj_close_50ma),
                price200MAData: filteredPrices.map(item => item.adj_close_200ma),
                volumeData: filteredPrices.map(item => item.volume || 0),
                volume7MAData: filteredPrices.map(item => item.volume_7ma || 0),
                volume90MAData: filteredPrices.map(item => item.volume_90ma || 0)
            };
        }

        let currentData = filterDataByRange('ALL');

        const theme = {
            background: getComputedStyle(document.documentElement).getPropertyValue('--background').trim() || '#1f2023',
            foreground: getComputedStyle(document.documentElement).getPropertyValue('--foreground').trim() || '#bcb28d',
            accentBlue: getComputedStyle(document.documentElement).getPropertyValue('--accent-blue').trim() || '#58b2dc',
            accentMagenta: getComputedStyle(document.documentElement).getPropertyValue('--accent-magenta').trim() || '#e03c8a',
            textMuted: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim() || '#707c74',
            graphBg: getComputedStyle(document.documentElement).getPropertyValue('--graph-bg').trim() || '#212121'
        };

        const charts = [];

        const priceVolumeCtx = document.getElementById('priceVolumeChart').getContext('2d');
        let priceVolumeChart;
        if (!priceVolumeCtx) {
            console.error('Price + Volume chart context not found!');
        } else {
            priceVolumeChart = new Chart(priceVolumeCtx, {
                data: {
                    labels: currentData.labels,
                    datasets: [
                        { type: 'line', label: 'Adjusted Close Price', data: currentData.priceData, borderColor: theme.foreground, borderWidth: 1, fill: false, pointRadius: 0, yAxisID: 'y-price' },
                        { type: 'line', label: 'Price 20MA', data: currentData.price20MAData, borderColor: theme.accentBlue, borderWidth: 1, borderDash: [5, 5], fill: false, pointRadius: 0, yAxisID: 'y-price' },
                        { type: 'line', label: 'Price 50MA', data: currentData.price50MAData, borderColor: theme.accentMagenta, borderWidth: 1, borderDash: [5, 5], fill: false, pointRadius: 0, yAxisID: 'y-price' },
                        { type: 'line', label: 'Price 200MA', data: currentData.price200MAData, borderColor: theme.textMuted, borderWidth: 1, borderDash: [5, 5], fill: false, pointRadius: 0, yAxisID: 'y-price' },
                        { type: 'bar', label: 'Volume', data: currentData.volumeData, backgroundColor: theme.accentMagenta + '80', borderColor: theme.accentMagenta, borderWidth: 1, yAxisID: 'y-volume', barPercentage: 0.7, categoryPercentage: 0.8 },
                        { type: 'line', label: 'Volume 7MA', data: currentData.volume7MAData, borderColor: theme.textMuted, borderWidth: 1, fill: false, pointRadius: 0, yAxisID: 'y-volume', hidden: true },
                        { type: 'line', label: 'Volume 90MA', data: currentData.volume90MAData, borderColor: theme.foreground, borderWidth: 1, fill: false, pointRadius: 0, yAxisID: 'y-volume', hidden: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 20, bottom: 20, left: 20, right: 20 } },
                    scales: {
                        x: { 
                            type: 'category', 
                            title: { display: true, text: 'Date', color: theme.foreground }, 
                            ticks: { color: theme.textMuted, maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 }, 
                            grid: { display: true, color: theme.textMuted + '33', drawBorder: true }
                        },
                        'y-price': { 
                            position: 'left', 
                            title: { display: true, text: 'Price', color: theme.foreground }, 
                            ticks: { color: theme.textMuted }, 
                            beginAtZero: false, suggestedMin: Math.min(...currentData.priceData) * 0.9, suggestedMax: Math.max(...currentData.priceData) * 1.1, 
                            grid: { display: true, color: theme.textMuted + '33', drawBorder: true }, 
                            type: 'linear', 
                            stack: 'price', 
                            stackWeight: 1 
                        },
                        'y-volume': { 
                            position: 'right', 
                            title: { display: true, text: 'Volume', color: theme.foreground }, 
                            ticks: { color: theme.textMuted }, 
                            grid: { display: false }, 
                            beginAtZero: true, 
                            max: Math.max(...currentData.volumeData) * 5, 
                            stack: 'volume', 
                            stackWeight: 5 
                        }
                    },
                    plugins: {
                        title: { display: true, text: 'Price + Volume Chart', color: theme.foreground },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`; } }, backgroundColor: theme.graphBg, bodyColor: theme.foreground, titleColor: theme.foreground },
                        legend: { labels: { color: theme.foreground } }
                    },
                    elements: { line: { tension: 0.1 } }
                }
            });
            charts.push(priceVolumeChart);
        }

        const volumeCtx = document.getElementById('volumeChart').getContext('2d');
        if (!volumeCtx) {
            console.error('Volume chart context not found!');
        } else {
            const volumeChart = new Chart(volumeCtx, {
                data: {
                    labels: fullLabels,
                    datasets: [
                        { type: 'bar', label: 'Volume', data: fullVolumeData, backgroundColor: theme.accentMagenta + '80', borderColor: theme.accentMagenta, borderWidth: 1, yAxisID: 'y' },
                        { type: 'line', label: 'Volume 7MA', data: fullVolume7MAData, borderColor: theme.textMuted, borderWidth: 2, fill: false, pointRadius: 0, yAxisID: 'y' },
                        { type: 'line', label: 'Volume 90MA', data: fullVolume90MAData, borderColor: theme.accentBlue, borderWidth: 2, fill: false, pointRadius: 0, yAxisID: 'y' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'category', title: { display: true, text: 'Date', color: theme.foreground }, ticks: { color: theme.textMuted, maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 }, grid: { color: theme.graphBg + '33' } },
                        y: { title: { display: true, text: 'Volume', color: theme.foreground }, ticks: { color: theme.textMuted }, beginAtZero: true, max: Math.max(...fullVolumeData) * 5, grid: { color: theme.graphBg + '33' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Volume Chart', color: theme.foreground },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`; } }, backgroundColor: theme.graphBg, bodyColor: theme.foreground, titleColor: theme.foreground },
                        legend: { labels: { color: theme.foreground } }
                    }
                }
            });
            charts.push(volumeChart);
        }

        const priceCtx = document.getElementById('priceChart').getContext('2d');
        if (!priceCtx) {
            console.error('Price chart context not found!');
        } else {
            const priceChart = new Chart(priceCtx, {
                data: {
                    labels: fullLabels,
                    datasets: [{ type: 'line', label: 'Adjusted Close Price', data: fullPriceData, borderColor: theme.accentBlue, borderWidth: 2, fill: false, pointRadius: 0, yAxisID: 'y' }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'category', title: { display: true, text: 'Date', color: theme.foreground }, ticks: { color: theme.textMuted, maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 }, grid: { color: theme.graphBg + '33' } },
                        y: { title: { display: true, text: 'Price', color: theme.foreground }, ticks: { color: theme.textMuted }, beginAtZero: false, suggestedMin: Math.min(...fullPriceData) * 0.9, suggestedMax: Math.max(...fullPriceData) * 1.1, grid: { color: theme.graphBg + '33' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Price Chart', color: theme.foreground },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`; } }, backgroundColor: theme.graphBg, bodyColor: theme.foreground, titleColor: theme.foreground },
                        legend: { labels: { color: theme.foreground } }
                    },
                    elements: { line: { tension: 0.1 } }
                }
            });
            charts.push(priceChart);
        }

        const dateRangeSelector = document.getElementById('dateRange');
        dateRangeSelector.addEventListener('change', function() {
            const selectedRange = this.value;
            currentData = filterDataByRange(selectedRange);
            
            if (priceVolumeChart) {
                priceVolumeChart.data.labels = currentData.labels;
                priceVolumeChart.data.datasets[0].data = currentData.priceData;
                priceVolumeChart.data.datasets[1].data = currentData.volumeData;
                priceVolumeChart.data.datasets[2].data = currentData.volume7MAData;
                priceVolumeChart.data.datasets[3].data = currentData.volume90MAData;
                
                const maxVolume = Math.max(...currentData.volumeData);
                priceVolumeChart.options.scales['y-volume'].max = maxVolume * 5;
                priceVolumeChart.options.scales['y-price'].suggestedMin = Math.min(...currentData.priceData) * 0.9;
                priceVolumeChart.options.scales['y-price'].suggestedMax = Math.max(...currentData.priceData) * 1.1;
                
                priceVolumeChart.update();
            }
        });

        let activeChartIndex = 0;
        const chartCanvases = document.querySelectorAll('.chart-wrapper > canvas');
        const controlsBar = document.querySelector('.controls-bar');
        const prevButton = document.getElementById('prevChart');
        const nextButton = document.getElementById('nextChart');
        const tabs = document.querySelectorAll('.tab');

        function updateChartVisibility() {
            chartCanvases.forEach((canvas, index) => {
                if (index === activeChartIndex) {
                    canvas.classList.add('active');
                    canvas.classList.remove('hidden');
                } else {
                    canvas.classList.add('hidden');
                    canvas.classList.remove('active');
                }
            });

            tabs.forEach((tab, index) => {
                if (index === activeChartIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            if (activeChartIndex === 0) {
                controlsBar.classList.add('active');
                if (priceVolumeChart) {
                    priceVolumeChart.resize();
                }
            } else {
                controlsBar.classList.remove('active');
            }
        }

        updateChartVisibility();

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                activeChartIndex = parseInt(this.getAttribute('data-chart-index'));
                updateChartVisibility();
            });
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowRight') {
                activeChartIndex = (activeChartIndex + 1) % chartCanvases.length;
                updateChartVisibility();
            } else if (event.key === 'ArrowLeft') {
                activeChartIndex = (activeChartIndex - 1 + chartCanvases.length) % chartCanvases.length;
                updateChartVisibility();
            }
        });

        nextButton.addEventListener('click', function() {
            activeChartIndex = (activeChartIndex + 1) % chartCanvases.length;
            updateChartVisibility();
        });

        prevButton.addEventListener('click', function() {
            activeChartIndex = (activeChartIndex - 1 + chartCanvases.length) % chartCanvases.length;
            updateChartVisibility();
        });

        const toggleLogScaleButton = document.getElementById('toggleLogScale');
        if (toggleLogScaleButton) {
            toggleLogScaleButton.addEventListener('click', function() {
                if (priceVolumeChart) {
                    const yAxis = priceVolumeChart.options.scales['y-price'];
                    yAxis.type = yAxis.type === 'logarithmic' ? 'linear' : 'logarithmic';
                    priceVolumeChart.update();
                } else {
                    console.error('priceVolumeChart is not defined.');
                }
            });
        }
    </script>
</body>
</html>